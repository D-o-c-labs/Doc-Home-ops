apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
    name: synology-csi
    namespace: flux-system
spec:
    gitImplementation: go-git
    ignore: |
        # exclude all
        /*
        # include gitops dirs
        !/deploy/kubernetes/v1.20
        snapshotter
    interval: 30m
    ref:
        branch: main
    timeout: 60s
    url: https://github.com/zebernst/synology-csi-talos.git
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
    name: cluster-infrastructure-synology-csi
    namespace: flux-system
spec:
    interval: 30m
    path: ./deploy/kubernetes/v1.20
    prune: true
    wait: false
    decryption:
        provider: sops
        secretRef:
            name: sops-age
    sourceRef:
        kind: GitRepository
        name: synology-csi
    dependsOn:
        - name: flux
    postBuild:
        substituteFrom:
            - kind: ConfigMap
              name: cluster-settings
              optional: false
    patches:
        - patch: |-
            apiVersion: storage.k8s.io/v1
            kind: StorageClass
            metadata:
                name: synology-iscsi
                annotations:
                    storageclass.kubernetes.io/is-default-class: "true"
            provisioner: csi.san.synology.com
            # if all params are empty, synology CSI will choose an available location to create volume
            parameters:
                dsm: piscionas.piscio.net
                location: /volume2
                csi.storage.k8s.io/fstype: ext4
            reclaimPolicy: Retain
            allowVolumeExpansion: true
          target:
            name: synology-iscsi
            kind: StorageClass
